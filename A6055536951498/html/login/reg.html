<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>Hello APP</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/common.css" />
    <link rel="stylesheet" type="text/css" href="../../css/login/login.css" />
</head>
<body>
  <div id="header">
		<h1>
			<div class="cancel" tapmode="active" onclick="api.closeWin();"></div>
			注 册
		</h1>
  </div>
<div id="tbh5v0">
    <div class="log_reg_box">
        <ul class="tab" id="logRegTab">
            <li id="mob_log" class="curr" onClick="changeForm(this)">
                <span>
                    <font>手机注册</font>
                </span>
            </li>
            <li id="email_log" class="curr currr" onClick="changeForm(this)">
                <span>
                    <font>邮箱注册</font>
                </span>
            </li>
        </ul>
        <div id="logRegTabCon">
            <div class="log_reg_item" id="phonearea">
                <div id="mobileForm" name="mobileForm" >
                        <div class="field phone">
                            <input type="text" id="username" name="username" placeholder="手机号" class="c-form-txt-normal" onBlur="checkMobilePhone(this.value);" />
                            <div class="tips">
                                <span id="mobile_phone_notice"></span>
                            </div>
                        </div>
                        <div class="field pwd">
                            <input type="password" id="password" name="password" placeholder="密码" class="c-form-txt-normal" onBlur="check_password(this.value);" />
                            <div class="tips">
                                <span id="password_notice"></span>
                            </div>
                        </div>
                        <div class="field pwd">
                            <input type="password" id="password2" name="password2" placeholder="确认密码" class="c-form-txt-normal" onBlur="check_confirm_password(this.value);" />
                            <div class="tips">
                                <span id="confirm_password_notice"></span>
                            </div>
                        </div>
                        <div class="yanzheng"  style=" margin-top:0px;">
                              <div class="codeTxt">
                                <input type="text" id="mobile_code"  name="mobile_code" placeholder="手机验证码" />
                              </div>
                               <div class="codePhoto">
                                <input id="zphone" type="button" rel="mobile" value="获取手机验证码 " onClick="sendcode(this)" class="zphone" style=" color:#FFF">
                               </div>
                        </div>
                        <input type="submit" id="btn_submit" name="Submit" class="btn_big1" value="注 册" onclick="submit()"/>
            </div>
            </div>
            <div class="log_reg_item hide" id="emailarea">
                <div id="emailForm" name="emailForm">
                    <div class="field email">
                            <div class="st">
                                <input type="email" name="username" placeholder="邮箱地址" value="" class="c-form-txt-normal" id="username" onBlur="checkEmail2(this.value);" />
                            </div>
                            <div class="tips">
                                <span id="email_notice"></span>
                            </div>
                        </div>
                        <div class="field pwd">
                            <div>
                                <input type="password" name="password" id="password" onBlur="check_password(this.value);" value="" placeholder="密码" class="c-form-txt-normal" />
                            </div>
                            <div class="tips">
                                <span id="password_notice"> </span>
                            </div>
                        </div>
                        <div class="field pwd">
                            <div>
                                <input type="password" name="password2" id="password2" onBlur="check_confirm_password(this.value);" value="" placeholder="确认密码" class="c-form-txt-normal">
                            </div>
                            <div class="tips">
                                <span id="confirm_password_notice"> </span>
                            </div>
                        </div>
                        <if condition="$regis_smtp_enable eq 1">
                        <div class="yanzheng" style=" margin-top:0px;">
                              <div class="codeTxt">
                                <input type="text" id="email_code" name="email_code"  placeholder="邮箱验证码"/></div>
                                   <div class="codePhoto">
                                    <input id="zemail" name="getemailcode" type="button" rel="email" value="获取邮箱验证码 " class="zphone" onClick="sendcode(this)" style=" color:#FFF" />
                                  </div>
                        </div>
                        </if>
                        <input type="checkbox" style="display: none" name="agreement" value="1" checked="checked" required />
                        <input type="submit" id="btn_submit" name="Submit" class="btn_big1" value="注 册" onclick="submit()"/>
                </div>
            </div>
        </div>
    </div>
<include file="public/footer"/>
</div>
<script type="text/javascript">

setCurrentForm($("#mobileForm"));
var flag = false;

function submit() {
  var data = check_submit();
  if(!data)
    return false;
  glo.post('/mobile/user/reg', data, function(res) {
    if(res.status != 1) {
      alert(res.msg);
    } else {
      glo.set_loginInfo(res);
      glo.open_frame([
        {
            url: './index.html',
            bounces: false,
            rect:{
                x: 0,
                y: 0,
                w: 'auto',
                h: $api.getStorage('main_h'),

            }
          }, {
            url: '../public/footer_nav.html',
            bounces: false,
            rect:{
                x: 0,
                y: $api.getStorage('main_h'),
                w: 'auto',
                h: 'auto'
            }
          }
      ]);
    }
  });
}

function changeForm(obj){
    $(obj).removeClass('currr');
    $(obj).siblings().addClass('currr');
    if($(obj).attr('id')=='mob_log'){
        $('#phonearea').show();
        setCurrentForm($("#mobileForm"))
        $('#emailarea').hide();
    }else{
        $('#phonearea').hide();
        setCurrentForm($("#emailForm"))
        $('#emailarea').show();
    }
}

function setCurrentForm(formObj) {
    currentForm = $(formObj);
}

function checkEmail2(email){
    if(email == ''){
        $('#email_notice').css('color','red');
        $('#email_notice').html('* 邮件地址不能为空');
        flag = false;
    }else if(checkEmail(email)){
      glo.get('/Home/Api/issetMobileOrEmail?mobile=' + email, function(data) {
          if(data == '0')
          {
              $('#email_notice').css('color','green');
              $('#email_notice').html('* 可以注册');
              flag = true;
          }else{
              $('#email_notice').css('color','red');
              $('#email_notice').html('* 邮箱已经存在');
              flag = false;
          }
      });
    }else{
        $('#email_notice').css('color','red');
        $('#email_notice').html('* 邮件地址不正确');
        flag = false;
    }
}


function checkMobilePhone(mobile){
    if(mobile == ''){
        $('#mobile_phone_notice').css('color','red');
        $('#mobile_phone_notice').html('* 手机号码不能为空');
        flag = false;
    }else if(checkMobile(mobile)){
      glo.get('/Home/Api/issetMobile?mobile=' + mobile, function(data)
      {
          if(data == '0')
          {
              $('#mobile_phone_notice').css('color','green');
              $('#mobile_phone_notice').html('* 可以注册');
              flag = true;
          }else{
              $('#mobile_phone_notice').css('color','red');
              $('#mobile_phone_notice').html('* 手机号已存在');
              flag = false;
          }
      });

    }else{
        $('#mobile_phone_notice').css('color','red');
        $('#mobile_phone_notice').html('* 手机号码格式不正确');
        flag = false;
    }
}


function check_password(password) {
    if (password.indexOf(" ") != -1) {
        $(currentForm).find('#password_notice').css('color','red').html("登录密码不能包含空格");
        flag = false;
    } else if (password.length < 6) {
        $(currentForm).find('#password_notice').css('color','red').html('- 登录密码不能少于 6 个字符。');
        flag = false;
    } else {
        $(currentForm).find('#password_notice').css('color','green').html('可以注册');
        flag = true;
    }
}

function check_confirm_password(confirm_password) {
    var password = $(currentForm).find('#password').val();
    if (password.indexOf(" ") != -1) {
        $(currentForm).find('#confirm_password_notice').css('color','red').html("确认密码不能包含空格");
        flag = false;
        return false;
    }
    if (confirm_password.length < 6) {
        $(currentForm).find('#confirm_password_notice').css('color','red').html('- 登录密码不能少于 6 个字符。');
        flag = false;
        return false;
    }
    if (confirm_password != password) {
        $(currentForm).find('#confirm_password_notice').css('color','red').html('两次密码不一致');
        flag = false;
    } else {
        $(currentForm).find('#confirm_password_notice').css('color','green').html('可以注册');
        flag = true;
    }
}


function check_submit()
{
    var username = $.trim($(currentForm).find('#username').val());
    var password = $(currentForm).find('#password').val();
    var password2= $(currentForm).find('#password2').val();
    var mobile_code = $(currentForm).find('#mobile_code').val();
    mobile_code = mobile_code? mobile_code : $(currentForm).find('#email_code').val()
    if(username.length >0 && password.length > 0 && password2.length > 0 && flag)
    {
        return {username: username, password: password, password2: password2, mobile_code: mobile_code};
    } else{
        return false;
    }

}

function sendcode(o){
    if(flag){
      glo.post('/Home/Api/send_validate_code?t='+Math.random(),
        { type:$(o).attr('rel'),
          send:$.trim($(currentForm).find('#username').val()) ,
          scene:1
        }, function(res){
            if(res.status==1){
                layer.open({content:res.msg,time:1});
                countdown(o);
            }else{
                layer.open({content:res.msg,time:2});
            }
        });
    }
}

var wait = 150;
function countdown(obj, msg) {
    obj = $(obj);
    if (wait == 0) {
        obj.removeAttr("disabled");
        obj.val(msg);
        wait = 150;
    } else {
        if (msg == undefined || msg == null) {
            msg = obj.val();
        }
        obj.attr("disabled", "disabled");
        obj.val(wait + "秒后重新获取");
        wait--;
        setTimeout(function() {
            countdown(obj, msg)
        }, 1000)
    }
}
</script>
</body>
</html>
